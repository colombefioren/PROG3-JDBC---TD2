package com.jdbctd2;

import com.jdbctd2.model.*;
import com.jdbctd2.repository.DataRetriever;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

public class Main {
    public static void main(String[] args) {
        DataRetriever dataRetriever = new DataRetriever();

        // BeforeAll
        dataRetriever.initializeDB();

        // a) Dish findDishById(Integer id) - id = 1
        System.out.println("===> Dish findDishById(Integer id) | id = 1 <===");
        Dish dishA = dataRetriever.findDishById(1);
        System.out.println("id=1 : " + dishA);

        // b) Dish findDishById(Integer id) - id = 999
        System.out.println("\n===> Dish findDishById(Integer id) | id = 999 <===");
        try {
            Dish dishB = dataRetriever.findDishById(999);
            System.out.println("id=999 : " + dishB);
        } catch (RuntimeException e) {
            System.out.println("Dish with id 999 not found. Error: " + e.getMessage());
        }

        // c) List<Ingredient> findIngredients(int page, int size) - page=2 size=2
        System.out.println(
                "\n===> List<Ingredient> findIngredients(int page, int size) | page=2,size=2 <===");
        List<Ingredient> ingredientListC = dataRetriever.findIngredients(2, 2);
        System.out.println("page=2,size=2 : " + ingredientListC);

        // d) List<Ingredient> findIngredients(int page, int size) - page=3 size=5
        System.out.println(
                "\n===> List<Ingredient> findIngredients(int page, int size) | page=3,size=5 <===");
        List<Ingredient> ingredientListD = dataRetriever.findIngredients(3, 5);
        System.out.println("page=3,size=5 : " + ingredientListD);

        // e) List<Dish> findDishesByIngredientName(String IngredientName) - eur
        System.out.println(
                "\n===> List<Dish> findDishesByIngredientName(String IngredientName) | eur <===");
        List<Dish> dishesByIngredientNameE = dataRetriever.findDishesByIngredientName("eur");
        System.out.println("dishesByIngredientName : " + dishesByIngredientNameE);

        // f) List<Ingredient> findIngredientsByCriteria(...) - ingredientName=null category=VEGETABLE
        // dishName=null page=1 size=10
        System.out.println(
                "\n===> List<Ingredient> findIngredientsByCriteria(...) | ingredientName=null category=VEGETABLE dishName=null page=1 size=10 <===");
        List<Ingredient> ingredientListF =
                dataRetriever.findIngredientsByCriteria(null, CategoryEnum.VEGETABLE, null, 1, 10);
        System.out.println("ingredientList : " + ingredientListF);

        // g) List<Ingredient> findIngredientsByCriteria(...) - ingredientName=cho category=null
        // dishName=Sal page=1 size=10
        System.out.println(
                "\n===> List<Ingredient> findIngredientsByCriteria(...) | ingredientName=cho category=null dishName=Sal page=1 size=10 <===");
        List<Ingredient> ingredientListG =
                dataRetriever.findIngredientsByCriteria("cho", null, "Sal", 1, 10);
        System.out.println("ingredientList : " + ingredientListG);

        // h) List<Ingredient> findIngredientsByCriteria(...) - ingredientName=cho category=null
        // dishName=gâteau page=1 size=10
        System.out.println(
                "\n===> List<Ingredient> findIngredientsByCriteria(...) | ingredientName=cho category=null dishName=gâteau page=1 size=10");
        List<Ingredient> ingredientListH =
                dataRetriever.findIngredientsByCriteria("cho", null, "gâteau", 1, 10);
        System.out.println("ingredientList : " + ingredientListH);

        // i) List<Ingredient> createIngredient(...) - fromage and oignon
        System.out.println("\n===> List<Ingredient> createIngredient(...) | fromage and oignon <===");
        Ingredient fromage = new Ingredient("Fromage", CategoryEnum.DAIRY, 1200.0);
        Ingredient oignon = new Ingredient("Oignon", CategoryEnum.VEGETABLE, 500.0);
        try {
            List<Ingredient> createdIngredientsI =
                    dataRetriever.createIngredients(new ArrayList<>(Arrays.asList(fromage, oignon)));
            System.out.println("createdIngredients : " + createdIngredientsI);
        } catch (RuntimeException e) {
            System.out.println("Error while creating ingredients : " + e.getMessage());
        }

        // j) List<Ingredient> createIngredient(...) - carotte and laitue
        System.out.println("\n===> List<Ingredient> createIngredient(...) | carotte and laitue <===");
        Ingredient carotte = new Ingredient("Carotte", CategoryEnum.VEGETABLE, 2000.0);
        Ingredient laitue = new Ingredient(1, "Laitue", CategoryEnum.VEGETABLE, 2000.0);
        try {
            List<Ingredient> createdIngredientsJ =
                    dataRetriever.createIngredients(new ArrayList<>(Arrays.asList(carotte, laitue)));
            System.out.println("createdIngredients : " + createdIngredientsJ);
        } catch (RuntimeException e) {
            System.out.println("Error while creating ingredients : " + e.getMessage());
        }

        // k) Dish saveDish(...) - soupe de légumes
        System.out.println(
                "\n===> Dish saveDish(...) | name=Soupe de légumes dishType=START ingredients=Oignon <===");
        try {
            Ingredient oignonIngredient = dataRetriever.findIngredientByName("Oignon");
            if (oignonIngredient == null) {
                System.out.println("Oignon ingredient not found");
            } else {
                DishIngredient oignonDishIng =
                        new DishIngredient(null, oignonIngredient, 5.0, UnitType.PCS);
                Dish newDish = new Dish("Soupe de légumes", DishTypeEnum.START, List.of(oignonDishIng));

                Dish savedDish = dataRetriever.saveDish(newDish);
                System.out.println("Saved dish: " + savedDish);
            }
        } catch (Exception e) {
            System.out.println("Error saving dish: " + e.getMessage());
        }

        // l) Dish saveDish(...) - salade fraîche
        System.out.println(
                "\n===> Dish saveDish(...) | id=1 name=Salade fraîche dishType=START ingredients=Oignon, Laitue, Tomate, Fromage <===");
        try {
            Ingredient laitueIngredient = dataRetriever.findIngredientByName("laitue");
            Ingredient fromageIngredient = dataRetriever.findIngredientByName("fromage");
            Ingredient tomateIngredient = dataRetriever.findIngredientByName("tomate");
            Ingredient oignonIngredient = dataRetriever.findIngredientByName("oignon");

            if (laitueIngredient == null
                    || fromageIngredient == null
                    || tomateIngredient == null
                    || oignonIngredient == null) {
                System.out.println("One or more ingredients not found");
            } else {
                DishIngredient laitueDishIng =
                        new DishIngredient(null, laitueIngredient, 1.0, UnitType.PCS);
                DishIngredient fromageDishIng =
                        new DishIngredient(null, fromageIngredient, 0.125, UnitType.KG);
                DishIngredient tomateDishIng = new DishIngredient(null, tomateIngredient, 0.5, UnitType.KG);
                DishIngredient oignonDishIng2 =
                        new DishIngredient(null, oignonIngredient, 1.0, UnitType.PCS);
                Dish newDishL =
                        new Dish(
                                1,
                                "Salade fraîche",
                                DishTypeEnum.START,
                                new ArrayList<>(
                                        Arrays.asList(laitueDishIng, fromageDishIng, tomateDishIng, oignonDishIng2)));
                Dish savedDishL = dataRetriever.saveDish(newDishL);
                System.out.println("savedDish : " + savedDishL);
            }
        } catch (Exception e) {
            System.out.println("Error saving dish: " + e.getMessage());
        }

        // m) Dish saveDish(...) - Salade de fromage
        System.out.println(
                "\n===> Dish saveDish(...) | id=1 name=Salade de fromage dishType=START ingredients=Fromage <===");
        try {
            Ingredient fromageIngredient = dataRetriever.findIngredientByName("fromage");
            if (fromageIngredient == null) {
                System.out.println("Fromage ingredient not found");
            } else {
                DishIngredient fromageDishIng =
                        new DishIngredient(null, fromageIngredient, 0.125, UnitType.KG);
                Dish newDishM =
                        new Dish(
                                1,
                                "Salade de fromage",
                                DishTypeEnum.START,
                                new ArrayList<>(Collections.singletonList(fromageDishIng)));
                Dish savedDishM = dataRetriever.saveDish(newDishM);
                System.out.println("savedDish : " + savedDishM);
            }
        } catch (Exception e) {
            System.out.println("Error saving dish: " + e.getMessage());
        }

        // test after price attribute added in Dish entity

        // initialize data before the new tests
        dataRetriever.initializeDB();

        System.out.println(
                "\n===> Test with findDishById after price attribute added in Dish entity <===");
        Dish dishT1 = dataRetriever.findDishById(1);
        System.out.println("Dish name : " + dishT1.getName());
        System.out.println("Dish price : " + dishT1.getPrice());
        System.out.println("Dish cost (ingredients) : " + dishT1.getDishCost());
        System.out.println("Dish Gross Margin : " + dishT1.getGrossMargin());

        System.out.println();

        Dish dishT2 = dataRetriever.findDishById(3);
        System.out.println("Dish name : " + dishT2.getName());
        System.out.println("Dish price : " + dishT2.getPrice());
        System.out.println("Dish cost (ingredients) : " + dishT2.getDishCost());
        try {
            System.out.println("Dish Gross Margin : " + dishT2.getGrossMargin());
        } catch (RuntimeException e) {
            System.out.println(e.getMessage());
        }

        System.out.println("\n===> Test with saveDish after price attribute added in Dish entity <===");
        System.out.println("\nnew Dish");
        try {
            Ingredient laitueT3 = dataRetriever.findIngredientByName("laitue");
            if (laitueT3 == null) {
                System.out.println("Laitue ingredient not found");
            } else {
                DishIngredient laitueT3DishIng = new DishIngredient(null, laitueT3, 1.0, UnitType.PCS);
                List<DishIngredient> newDishIngT3 =
                        new ArrayList<>(Collections.singletonList(laitueT3DishIng));
                Dish newDishT3 = new Dish("Rabbit Cabbage", DishTypeEnum.START, newDishIngT3, 1200.00);
                Dish savedDishT3 = dataRetriever.saveDish(newDishT3);
                System.out.println("savedDish : " + savedDishT3);
            }
        } catch (Exception e) {
            System.out.println("Error: " + e.getMessage());
        }

        System.out.println("\nChange price");
        try {
            Dish rizDish = dataRetriever.findDishById(3);
            rizDish.setPrice(5000.00);
            Dish newRizDish = dataRetriever.saveDish(rizDish);
            System.out.println("newRizDish : " + newRizDish);
        } catch (Exception e) {
            System.out.println("Error: " + e.getMessage());
        }

        dataRetriever.initializeDB();

        System.out.println("\n===> Test getGrossMargin after db normalization");
        List<Dish> allDishes = new ArrayList<>();
        for (int i = 5; i > 0; i--) {
            try {
                allDishes.add(dataRetriever.findDishById(i));
            } catch (RuntimeException e) {
                System.out.println("Dish with id " + i + " not found: " + e.getMessage());
            }
        }
        for (Dish dish : allDishes) {
            try {
                System.out.println("\nDish name : " + dish.getName());
                System.out.println("Dish price : " + dish.getPrice());
                System.out.println("Dish cost (ingredients) : " + dish.getDishCost());
                System.out.println("Gross Margin : " + dish.getGrossMargin());
            } catch (RuntimeException e) {
                System.out.println(e.getMessage());
            }
        }

        System.out.println("\n===> Stock::getQuantity <===");
        List<Ingredient> allIngredients = new ArrayList<>();
        for (int i = 5; i > 0; i--) {
            try {
                allIngredients.add(dataRetriever.findIngredientById(i));

            } catch (RuntimeException e) {
                System.out.println("Ingredient with id " + i + " not found: " + e.getMessage());
            }
        }

        for (Ingredient ingredient : allIngredients) {
            System.out.println("\nIngredient name : " + ingredient.getName());
            System.out.println(
                    "Stock : " + ingredient.getStockValueAt(Instant.parse("2024-01-06T12:00:00Z")));
        }

        // initialize data at the end too cause why not
        dataRetriever.initializeDB();
    }
}
